<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> Kama</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-国赛分区赛Reverse"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2022/07/05/%E5%9B%BD%E8%B5%9B%E5%88%86%E5%8C%BA%E8%B5%9BReverse/" class="article-date">
  <time datetime="2022-07-05T08:17:33.769Z" itemprop="datePublished">2022-07-05</time>
</a>   
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">6.4k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">28 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="国赛分区赛Reverse"><a href="#国赛分区赛Reverse" class="headerlink" title="国赛分区赛Reverse"></a>国赛分区赛Reverse</h1><h2 id="havetea"><a href="#havetea" class="headerlink" title="havetea"></a>havetea</h2><p><code>flag&#123;c616454f52a6334273b5f455a10ef818&#125;</code></p>
<p>拿到题目，exeinfope查壳，无壳32位文件,放入IDA分析。我们可以大体梳理出程序逻辑：先对输入的secret key进行长度判断，16字节，然后进行加密，然后判断。判断成功则进行下一次对serect message的输入，进行长度判断，32字节，然后进行加密，判断。</p>
<p>我们来看对key的加密函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __thiscall <span class="title function_">sub_B920F0</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> *this)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  v2 = *this;</span><br><span class="line">  result = this[<span class="number">1</span>];</span><br><span class="line">  v4 = <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v1 -= <span class="number">0x61C88647</span>;</span><br><span class="line">    v2 += (v1 + result) ^ (dword_BBAA90 + <span class="number">16</span> * result) ^ (dword_BBAA94 + (result &gt;&gt; <span class="number">5</span>));</span><br><span class="line">    result += (v1 + v2) ^ (dword_BBAA98 + <span class="number">16</span> * v2) ^ (dword_BBAA9C + (v2 &gt;&gt; <span class="number">5</span>));</span><br><span class="line">    --v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v4 );</span><br><span class="line">  *this = v2;</span><br><span class="line">  this[<span class="number">1</span>] = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>减去0x61C88647就相当于加上0x9E3779B9（补码），这个值就很敏感，是Tea加密的特征值，我们只需要逆着写出解密脚本就行。比较数据我们通过动态调试读取内存得出。</p>
<p>Secret Key：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TeaDecrypto</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="keyword">global</span> DeltaArr</span><br><span class="line">    <span class="keyword">global</span> DeltaVariable</span><br><span class="line">    <span class="keyword">global</span> SecretKey</span><br><span class="line">    v1=a[<span class="number">0</span>]</span><br><span class="line">    v2=a[<span class="number">1</span>]</span><br><span class="line">    DeltaEnd=DeltaVariable</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        v2-=((((v1&lt;&lt;<span class="number">4</span>)&amp;<span class="number">0xffffffff</span>)+DeltaArr[<span class="number">2</span>])&amp;<span class="number">0xffffffff</span>)^((v1+DeltaEnd)&amp;<span class="number">0xffffffff</span>)^((((v1&gt;&gt;<span class="number">5</span>)&amp;<span class="number">0xffffffff</span>)+DeltaArr[<span class="number">3</span>])&amp;<span class="number">0xffffffff</span>)</span><br><span class="line">        v2&amp;=<span class="number">0xffffffff</span></span><br><span class="line">        v1-=((((v2&lt;&lt;<span class="number">4</span>)&amp;<span class="number">0xffffffff</span>)+DeltaArr[<span class="number">0</span>])&amp;<span class="number">0xffffffff</span>)^((v2+DeltaEnd)&amp;<span class="number">0xffffffff</span>)^((((v2&gt;&gt;<span class="number">5</span>)&amp;<span class="number">0xffffffff</span>)+DeltaArr[<span class="number">1</span>])&amp;<span class="number">0xffffffff</span>)</span><br><span class="line">        v1&amp;=<span class="number">0xffffffff</span></span><br><span class="line">        DeltaEnd-=Delta</span><br><span class="line">    <span class="comment"># print(hex(v1),hex(v2))</span></span><br><span class="line">    tmp=struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>,v1)</span><br><span class="line">    SecretKey+=<span class="built_in">str</span>(tmp,encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    tmp=struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>,v2)</span><br><span class="line">    SecretKey+=<span class="built_in">str</span>(tmp,encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">          </span><br><span class="line">Delta=<span class="number">0x9E3779B9</span></span><br><span class="line">DeltaArr=[<span class="number">0x9E</span>, <span class="number">0x37</span>, <span class="number">0x79</span>, <span class="number">0xB9</span>]</span><br><span class="line">VerifyData1=[<span class="number">0xE66F0E9E</span>, <span class="number">0x42A17CD6</span>] </span><br><span class="line">VerifyData2=[<span class="number">0x5BDDE878</span>, <span class="number">0xD236F4AD</span>]</span><br><span class="line">SecretKey=<span class="string">&#x27;&#x27;</span></span><br><span class="line">DeltaVariable=Delta*<span class="number">32</span></span><br><span class="line">TeaDecrypto(VerifyData1)</span><br><span class="line">TeaDecrypto(VerifyData2)</span><br><span class="line"><span class="built_in">print</span>(SecretKey)</span><br></pre></td></tr></table></figure>

<p>得到<code>key=please_drink_tea</code></p>
<p>接下来看对secret message的加密函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __fastcall <span class="title function_">sub_B92170</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> *a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [esp+14h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v7 = <span class="number">32</span>;</span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  v3 = *a1;</span><br><span class="line">  v4 = a1[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = result + *(_DWORD *)(a2 + <span class="number">4</span> * (result &amp; <span class="number">3</span>));</span><br><span class="line">    result -= <span class="number">0x61C88647</span>;</span><br><span class="line">    v3 += v5 ^ (v4 + ((<span class="number">16</span> * v4) ^ (v4 &gt;&gt; <span class="number">5</span>)));</span><br><span class="line">    v4 += (result + *(_DWORD *)(a2 + <span class="number">4</span> * ((result &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>))) ^ (v3 + ((<span class="number">16</span> * v3) ^ (v3 &gt;&gt; <span class="number">5</span>)));</span><br><span class="line">    --v7;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v7 );</span><br><span class="line">  a1[<span class="number">1</span>] = v4;</span><br><span class="line">  *a1 = v3;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传入的参数是我们的输入和Key，动态调试分析程序，传入8字节，每4字节一组，传入的key分为四组，四字节一组。再往下分析加密，发现是典型的xtea加密。同样的逆着写出解密脚本，带入动态调试得到的比较数据。</p>
<p>Secret Message：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TeaDecrypto</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="keyword">global</span> Delta</span><br><span class="line">    <span class="keyword">global</span> SecretKey</span><br><span class="line">    <span class="keyword">global</span> DeltaEveryTurn</span><br><span class="line">    <span class="keyword">global</span> Flag</span><br><span class="line">    v1=a[<span class="number">0</span>]</span><br><span class="line">    v2=a[<span class="number">1</span>]</span><br><span class="line">    DeltaEveryRound=DeltaEveryTurn</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        v2 -= ((DeltaEveryRound + (SecretKey[(DeltaEveryRound&gt;&gt;<span class="number">11</span>)&amp;<span class="number">3</span>])&amp;<span class="number">0xffffffff</span>)&amp;<span class="number">0xffffffff</span>) ^ ((v1 + (((v1&lt;&lt;<span class="number">4</span>)&amp;<span class="number">0xffffffff</span>) ^ ((v1 &gt;&gt; <span class="number">5</span>)&amp;<span class="number">0xffffffff</span>)))&amp;<span class="number">0xffffffff</span>)</span><br><span class="line">        v2&amp;=<span class="number">0xffffffff</span></span><br><span class="line">        DeltaEveryRound-=Delta</span><br><span class="line">        v1 -= ((DeltaEveryRound+SecretKey[DeltaEveryRound &amp; <span class="number">3</span>])&amp;<span class="number">0xffffffff</span>) ^ ((v2 + (((v2&lt;&lt;<span class="number">4</span>)&amp;<span class="number">0xffffffff</span>) ^ ((v2 &gt;&gt; <span class="number">5</span>)&amp;<span class="number">0xffffffff</span>)))&amp;<span class="number">0xffffffff</span>)</span><br><span class="line">        v1&amp;=<span class="number">0xffffffff</span></span><br><span class="line">    <span class="comment"># print(hex(v1),hex(v2))</span></span><br><span class="line">    tmp=struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>,v1)</span><br><span class="line">    Flag+=<span class="built_in">str</span>(tmp,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    tmp=struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>,v2)</span><br><span class="line">    Flag+=<span class="built_in">str</span>(tmp,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">Flag=<span class="string">&#x27;&#x27;</span>   </span><br><span class="line">SecretKey=[<span class="number">0x61656c70</span>, <span class="number">0x645f6573</span>, <span class="number">0x6b6e6972</span>, <span class="number">0x6165745f</span>]</span><br><span class="line">Delta=<span class="number">0x9e3779b9</span></span><br><span class="line">DeltaEveryTurn=<span class="number">32</span>*Delta</span><br><span class="line">Compare_data1=[<span class="number">0x7D758E0A</span>, <span class="number">0xEDAFF6AD</span>] </span><br><span class="line">Compare_data2=[<span class="number">0x9DDE7E86</span>, <span class="number">0xE3D36CD5</span>] </span><br><span class="line">Compare_data3=[<span class="number">0xABD3C82E</span>, <span class="number">0x6B7B2CFE</span>] </span><br><span class="line">Compare_data4=[<span class="number">0x2C6608C2</span>, <span class="number">0x0686A1DA</span>]</span><br><span class="line">TeaDecrypto(Compare_data1)</span><br><span class="line">TeaDecrypto(Compare_data2)</span><br><span class="line">TeaDecrypto(Compare_data3)</span><br><span class="line">TeaDecrypto(Compare_data4)</span><br><span class="line"><span class="built_in">print</span>(Flag)</span><br></pre></td></tr></table></figure>

<p>得到<code>Message=c616454f52a6334273b5f455a10ef818</code></p>
<p>做题的时候遇到了一个一直想不通的问题，在我动态调试获取xtea加密的比较数据，然后解密发现原始数据太大，根本不是可以被直接输入的字符。百思不得其解去查看了wp发现我的比较数据和wp里面的有细微差别，当时没在意，就把wp里的比较数据带进去，最后的结果跟wp里的一样。我当时很高兴觉得题目已经解决了。但是我把结果带进去调试（当时断点设在了<code>v18 = __rdtsc()</code>处，这个下面会提到），发现最后结果反馈了<em>Wrong！</em>这我就很不能理解了，我再反复查看比较数据，还是和先前一样有着细微差距。我注意到判断语句前有这样一段代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v18 = __rdtsc();</span><br><span class="line">      dword_3BBDB8 = v18;</span><br><span class="line">      v19 = <span class="number">28</span>;</span><br><span class="line">      v20 = (<span class="type">unsigned</span> <span class="type">int</span>)(dword_3BBDBC + v18 - dword_3BC5C4 - dword_3BC5C0) &gt;&gt; <span class="number">5</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v20 &gt; <span class="number">0x100</span> )</span><br><span class="line">        v20 = <span class="number">256</span>;</span><br><span class="line">      v21 = (_DWORD *)dword_3BBDC0[v20];</span><br></pre></td></tr></table></figure>

<p>我们查询*__rdtsc()*函数，msdn上是这样解释的：<code>Generates the _rdtsc instruction, which returns the processor time stamp. The processor time stamp records the number of clock cycles since the last reset.</code><strong>tsc</strong>是<u>时间戳寄存器</u>记录时钟周期的。而此函数的作用是返回处理器时间戳记录的自上次重置以来的时钟周期数。当我们执行某程序时，处理器重置来处理过程，__rdtsc读取到该函数为止的周期数，也可理解为执行到该函数所费的时间。接下来<code>v20 = (unsigned int)(dword_3BBDBC + v18 - dword_3BC5C4 - dword_3BC5C0) &gt;&gt; 5</code>然后对v20的值是否大于0x100进行判断。v20的赋值式子里面的那些dword_***，我们往前寻找他们的赋值式，发现也同理。dword_3BBDBC和v18分别是执行到tea加密和xtea加密所费的时间，dword_3BC5C4和dword_3BC5C0</p>
<p>所记录的是在执行到两段加密前所费的时间。所以他们相加相减得到加密的总时长。对总时长进行判断。v21记录的是比较数据的地址，由dword_3BBDC0[v20]给v21赋值。所以加密的总时长影响最后的比较数据。我们断点下在<code>v18 = __rdtsc()</code>处，所以程序执行到此被我们停住了，但是tsc寄存器对时钟周期的记录未停止，所以导致函数返回的时间过长，使得我们读到的比较数据的值不正确，影响最终结果。我们将断点下在<code>v18 = __rdtsc()</code>之后就可以读到正确的比较数据，进而解密得到正确答案。</p>
<h2 id="puzzle"><a href="#puzzle" class="headerlink" title="puzzle"></a>puzzle</h2><p><code>flag&#123;23c3cb3aedbbfdd009d1bf52e530676a&#125;</code></p>
<p>拿到题目为exe文件，exeinfope查壳显示为<code>[ Tampared file ] UPX v.3.91w - 64 bit EXE signature</code>：被篡改的UPX。知道是UPX壳于是尝试直接使用FUPX脱壳发现FUPX不能将其识别成UPX壳，所以猜测是修改了壳程序的一些特征信息。用010Editor查看，发现几个节区名都为’vmp’，我们手动将其改为’UPX’。再使用FUPX进行脱壳，就可以识别到UPX壳并完成脱壳。尝试运行却失败。搜索资料发现，这是UPX在脱壳时原程序的重定位表丢失导致的。PE文件默认使用动态基址，所以没有重定位表会导致DLL文件等加载到内存的位置出现问题，导致程序无法正常运行。所以我们使用StudyPe将文件使用动态基址改为使用固定基址即可。（也可以不借助pe工具，直接010Editor打开文件，将Dllcharacteristics结构体中的IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE的值从1修改成0）尝然后双击程序，发现可以正常运行。</p>
<p>将文件放入IDA中分析，通过字符串查找锁定主函数。分析程序，代码有点长，而且是拿Go语言写的，直接静态分析不是很好分析，我们动态调试着分析。首先是对一堆值得初始化，接着input输入，然后有一段判断代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !v17 )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = v35;</span><br><span class="line">    v4 = <span class="number">0LL</span>;</span><br><span class="line">    v5 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">while</span> ( v4 &lt; <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; <span class="number">9</span>; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        v1 = (__int64 *)v40[<span class="number">3</span> * v4 - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> ( v40[<span class="number">3</span> * v4] &lt;= (<span class="type">unsigned</span> __int64)i )</span><br><span class="line">          sub_466740((__int64)v11, (__int64)v12);</span><br><span class="line">        v0 = *((<span class="type">unsigned</span> __int8 *)v1 + i);</span><br><span class="line">        <span class="keyword">if</span> ( !(_BYTE)v0 )</span><br><span class="line">        &#123;</span><br><span class="line">          v7 = v3[<span class="number">1</span>];</span><br><span class="line">          <span class="keyword">if</span> ( v7 &lt;= v5 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">          <span class="keyword">if</span> ( v7 &lt;= (<span class="type">unsigned</span> __int64)v5 )</span><br><span class="line">            sub_466740((__int64)v11, (__int64)v12);</span><br><span class="line">          v8 = *(<span class="type">unsigned</span> __int8 *)(v5 + *v3);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)v8 &lt; <span class="number">0x30</span>u || (<span class="type">unsigned</span> __int8)v8 &gt; <span class="number">0x39</span>u )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">          v0 = (<span class="type">unsigned</span> <span class="type">int</span>)(v8 - <span class="number">48</span>);</span><br><span class="line">          *((_BYTE *)v1 + i) = v0;</span><br><span class="line">          ++v5;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通过读内存，知道v3存储的就是我们输入到的那片内存的地址。v40是之前初始化过的变量，我们查看内存。v40为_int64类型数据，它的值为一段内存地址+两个9的格式，举个例子如：0x000000C000121E1F,0x0000000000000009,0x0000000000000009这样。v40[3 * v4 - 1]就是取得每第三个值，也就是那个内存地址里的值。接着，v0在一个字节一个字节地读那个地址里地数据，每个地址读9个字节。如果为零，则先对输入的值进行判断，将输入的范围控制在0-9。满足条件则写入替换那个零值。这里即为数独的特征。紧接着是一个判断语句，如果满足判断条件即可进入到输出flag的步骤里。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v3[<span class="number">1</span>] == v5 &amp;&amp; (v15 = sub_4B8720((__int64)&amp;v39, <span class="number">9LL</span>, <span class="number">9</span>, v13[<span class="number">8</span>]), v13[<span class="number">8</span>]) )</span><br></pre></td></tr></table></figure>

<p>v3[1]通过读内存可以知道是存储的输入字符串的长度。v5为填入数据的个数，也就是那些内存地址里零的个数。把零理解为数独的填空即是输入要把空填满的判断。然后是函数<em>sub_4B8720</em>传入的参数是数独的9*9的表，和一个值为9的int。在这个函数里面，对数组游戏规则进行判定，若满足则返回一。如上我们可以梳理出整个程序的结构：首先对变量初始化，然后让用户输入，对输入的值进行判断，符合规则的填入数独矩阵的0值。然后对空是否填满和数独是否获胜进行判断，若满足数独获胜条件，则进行下面的flag输出。所以，我们将内存中数独的数据读取下来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">v40=[<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>,</span><br><span class="line">     <span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">6</span>,</span><br><span class="line">     <span class="number">0</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,</span><br><span class="line">     <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="number">0</span>,</span><br><span class="line">     <span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">     <span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">     <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">7</span>,</span><br><span class="line">     <span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">     <span class="number">7</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>我们使用在线解数独工具完成此数独得到正确输入：<code>76135283549798674164925733849217386455934161872359295314</code></p>
<p>将其输入则得到flag。</p>
<h2 id="analgo"><a href="#analgo" class="headerlink" title="analgo"></a>analgo</h2><p><code>flag&#123;82fb373061ad9c8bfcee217d25e0bbc8&#125;</code></p>
<p>拿到题目为exe文件，exeinfope查壳为无壳64位可执行文件。分析程序，<code>if ( v21[1] == 42 )</code>是对输入长度的判断，看到最具特征的就是<code>&gt;&gt;&gt;&gt;&gt;&lt;&lt;&gt;&gt;&gt;&gt;&lt;[[[.]+]&lt;[-.+.].+.]].][.][[.+.]&gt;[.&lt;-.]&lt;.][.][[.-,.&lt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;&lt;&lt;&lt;.].][[.[.]&lt;.][.].-]].[.]</code>字符串，这很明显是<em>brainfuck</em>语言。而后的**<em>main_anal()<em>*<em>函数对</em>brainfuck*语言进行解释，然后对我们的输入进行加密。加密完成以后对加密字符串进行长度比较和与目标字符串比较：<code>if ( v7 == 42 ? runtime_memequal() : 0 )</code>。通过动态调试，发现比较数据其实就是在函数</em></em>*main_anal()***后赋值的一堆变量。对于这种brainfuck解释器的题目，直接分析解释代码相对而言比较困难，所以我们先尝试看看数据能否进行爆破。</p>
<p>首先我们尝试‘flag’加上‘a’去填充42个字节，然后观察加密后的结果并提取比较数据两个相比较：</p>
<blockquote>
<p>加密数据：38DDB37273B6F53877BAF93C7BBEFD407FC2014483C6054887CA094C8BCE0D508FD2115493D6155897AF</p>
<p>比较数据：38DDB3E82117069F09A2568BC8940D12F37EE677382D0C8CDE13F14CAF7B5002CA8B23A0F5F9661B2797</p>
</blockquote>
<p>可以看到我们正确输入前四个字节，然后加密以后前三字节的数据与比较数据相同。我们继续缩小正确的数据的大小（’fla’）</p>
<blockquote>
<p>加密数据：38DDF13473B6F53877BAF93C7BBEFD407FC2014483C6054887CA094C8BCE0D508FD2115493D6155897AF</p>
<p>比较数据：38DDB3E82117069F09A2568BC8940D12F37EE677382D0C8CDE13F14CAF7B5002CA8B23A0F5F9661B2797</p>
</blockquote>
<p>继续缩小正确数据大小也是这样，密文正确的字节数永远比明文正确的字节数少一，且加密顺序从左到右。其实到此我们就可以看出加密算法没有涉及扩散和混淆，所以我们可以在此题尝试爆破，但是爆破至少从第二个字节开始。</p>
<p>我认为爆破的切入点在于代码<code>if ( v7 == 42 ? runtime_memequal() : 0 )</code>处。*runtime_memequal()*是字符串比较函数，我们先看这个函数开始的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">runtime_memequal proc near</span><br><span class="line">rax, rbx</span><br><span class="line">short loc_9826AD</span><br><span class="line">mov     rax, 1</span><br><span class="line">retn</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loc_9826AD:</span><br><span class="line">     rsi, rax</span><br><span class="line">     rdi, rbx</span><br><span class="line">     rbx, rcx</span><br><span class="line">     memeqbody</span><br><span class="line"> runtime_memequal endp</span><br></pre></td></tr></table></figure>

<p>通过读内存或者分析代码我们可以知道，rax存储我们的密文，rbx存储着比较字符串。但这个函数并不是单纯的整体比较字符串，这里他有一个判断的跳转。为零说明两字符串相等，那么直接给rax寄存器赋一返回了，在后面会用test检测寄存器值是否为零，为零则直接输出’Right!’了。但如果比较结果非零值得话则会进行另外的操作。GO语言的新版调用约定为在参数不超过9个时采用其规定的寄存器传递参数。这里即是三步参数传递操作，前两步是传递目的操作数，源操作数，二第三步传递的则是比较长度，这个我们可以往前寻找rcx：<code>cmp     rcx, 2Ah</code>，也就是之前对长度的比较，但其实程序要想走到这一步就得先通过在输入后很快就进行的长度判断，所以其实这里rcx的值其实就是42，且这一步比较其实没有什么意义，所以这一行代码也就成了我们patch的切入点。，这个我们下文再提。这个<em>memeqbody</em>，还是挺有意思的，经过分析后得知他的大致逻辑是先对比较长度与8进行判断，因为rsi，rdi这些r开头的寄存器是64位寄存器，他们同时最多对八个字节的数据进行操作，小于八是寄存器总体比较完成以后将结果左移8减去比较长度的位数，若大于八则八字节八字节地比较，若是最后不足八字节，则将前一次比较地后8减去最后剩下地字节数位与最后剩下地字节凑成8位进行比较。同样地，不论哪一种比较</p>
<p>将目的操作数，源操作数，比较长度传递进函数，其实就给了我们不用输入全部正确的明文就可以获得正确反馈的可能。所以我们需要patch代码来给rcx赋上我们需要的比较长度。</p>
<p>原patch处代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">			cmp     rcx, 2Ah ; &#x27;*&#x27;</span><br><span class="line">			jz      short loc_773A4C</span><br><span class="line">			xor     eax, eax</span><br><span class="line">			jmp     short loc_773A59</span><br><span class="line">loc_A33A5D:</span><br><span class="line">			mov     rax, [rsp+168h+var_48]</span><br><span class="line">			call    runtime_memequal</span><br><span class="line">loc_773A59:</span><br><span class="line">			test    al, al</span><br><span class="line">			jnz     short loc_773AB7</span><br></pre></td></tr></table></figure>

<p>patch后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mov     rcx, 3</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">mov     rax, [rsp+168h+var_48]</span><br><span class="line">call    runtime_memequal</span><br><span class="line">test    al, al</span><br><span class="line">jnz     short loc_773AB7</span><br></pre></td></tr></table></figure>

<p>然后我们写脚本爆破：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">Blast_data=<span class="built_in">list</span>(<span class="string">&#x27;flag11111111111111111111111111111111111111\n&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>,<span class="number">42</span>):</span><br><span class="line">    exe_bin=<span class="built_in">bytearray</span>(<span class="built_in">open</span>(<span class="string">&quot;D:\\ctf\\analgo.exe&quot;</span>,<span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">    <span class="comment"># print(exe_bin)</span></span><br><span class="line">    exe_bin[<span class="number">0xb3045</span>]=i</span><br><span class="line">    <span class="built_in">open</span>(<span class="string">&quot;D:\\ctf\\analgo.exe&quot;</span>,<span class="string">&#x27;wb&#x27;</span>).write(exe_bin)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string.printable:</span><br><span class="line">        <span class="comment"># print(Blast_data)</span></span><br><span class="line">        Blast_data[i]=j</span><br><span class="line">        pipe=subprocess.Popen(<span class="string">&quot;D:\\ctf\\analgo&quot;</span>,bufsize=<span class="number">5</span>,stdout=subprocess.PIPE,stdin=subprocess.PIPE)</span><br><span class="line">        pipe.stdin.write(<span class="built_in">bytes</span>(<span class="string">&quot;&quot;</span>.join(Blast_data).encode(<span class="string">&quot;ascii&quot;</span>)))</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;right!\n&#x27;</span>==pipe.stdout.read():</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join(Blast_data).encode(<span class="string">&quot;utf-8&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>注：</p>
<p>mov指令源操作数的地址由010Editor读pe文件的.text节区的节表信息然后查找得到。</p>
<p>检测我们每字节爆破成功条件的字符串为’right!\n’，因为GO语言的fmt.Println函数是输出并且换行</p>
<p>爆破完成也就得到了我们的flag ^ ^</p>
<h2 id="Crakeme-3"><a href="#Crakeme-3" class="headerlink" title="Crakeme 3"></a>Crakeme 3</h2><p>拿到apk文件，用jadx打开，找到MainActivity进行分析，可以看到关键函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="comment">/* synthetic */</span> <span class="keyword">void</span> m0lambda$onCreate$<span class="number">0</span>$comctfcrackme3MainActivity(EditText editText, View view) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">obj</span> <span class="operator">=</span> editText.getText().toString();</span><br><span class="line">      <span class="keyword">if</span> (!obj.startsWith(<span class="string">&quot;flag&#123;&quot;</span>) || !obj.endsWith(<span class="string">&quot;&#125;&quot;</span>) || obj.length() &lt;= <span class="number">6</span> || obj.length() &gt;= <span class="number">39</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      Toast.makeText(<span class="built_in">this</span>, check(obj.substring(<span class="number">5</span>, obj.length() - <span class="number">1</span>)), <span class="number">0</span>).show();</span><br></pre></td></tr></table></figure>

<p>先对输入的格式进行检测判断（长度、格式），然后传入check函数中。直接对该函数进行搜索却没有结果，说明是动态注册的，在执行<em>System.loadLibrary</em>，会首先执行C组件里的*JNI_OnLoad()*函数，来实现告知VM当前so库所使用的JNI版本；对数据初始化；对Java类中的native函数进行注册等。</p>
<p>所以我们使用IDA反编译so文件，搜索*JNI_OnLoad()*：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !v1 )</span><br><span class="line"> &#123;</span><br><span class="line">   v3 = (*(*v5[<span class="number">0</span>] + <span class="number">48LL</span>))(v5[<span class="number">0</span>], <span class="string">&quot;com/ctf/crackme3/MainActivity&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> ( v3 )</span><br><span class="line">   &#123;</span><br><span class="line">     v4 = (*(*v5[<span class="number">0</span>] + <span class="number">1720LL</span>))(v5[<span class="number">0</span>], v3, off_724E0, <span class="number">1LL</span>);</span><br><span class="line">     result = <span class="number">65542LL</span>;</span><br><span class="line">     <span class="keyword">if</span> ( v4 &gt;= <span class="number">0</span> )</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">     <span class="built_in">puts</span>(<span class="string">&quot;register native method failed!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;cannot get class:%s\n&quot;</span>, <span class="string">&quot;com/ctf/crackme3/MainActivity&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>查看off_724E0地址处内存，可知道这里动态注册了名为check的函数，反编译该函数进行分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( sub_3D70(v3) == <span class="number">32</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v10 = <span class="number">16</span>;</span><br><span class="line">  v4 = <span class="built_in">malloc</span>(<span class="number">0x80</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( sub_4330(v3, v4, &amp;v10) )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = *a1;</span><br><span class="line">    v6 = <span class="string">&quot;Bad format&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line"> v9 = *v4 ^ <span class="number">0x39DEB332</span>;</span><br><span class="line">    v11 = v4[<span class="number">1</span>] ^ v9;</span><br><span class="line">    v12 = v4[<span class="number">2</span>] ^ v11;</span><br><span class="line">    v8 = v4[<span class="number">3</span>] ^ v12;</span><br><span class="line">    <span class="keyword">if</span> ( sub_43F0(&amp;v9) &amp;&amp; sub_44E0(&amp;v11) &amp;&amp; sub_4630(&amp;v8) )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = *a1;</span><br><span class="line">      v6 = <span class="string">&quot;right flag!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>if ( sub_3D70(v3) == 32 )</code>，32字节输入。<code>if ( sub_4330(v3, v4, &amp;v10) )</code>将输入分为4组每组8字节。有后面的四组异或可以猜测此处将输入每两字节的16进制当作一个新的字节化为了四组四字节数据。然后进行异或后传入三个加密函数进行加密。</p>
<p>首先我们尝试使用Findcrypto直接确定其加密方式。发现<em>sub_43F0</em>被识别为SHA1加密，代码中直接给出了明文第三个字节的数据，已经减小了爆破的运算量，我们提取他的比较数据进行数据爆破拿到第一组明文：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">compare_data=<span class="string">&#x27;2e60865e94119223c4657eac98d744ee909e66b8&#x27;</span></span><br><span class="line">arr=[]</span><br><span class="line"><span class="comment"># print(len(compare_data))</span></span><br><span class="line"><span class="keyword">for</span> index1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xff</span>):</span><br><span class="line">    <span class="keyword">for</span> index2 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xff</span>):</span><br><span class="line">        <span class="keyword">for</span> index3 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xff</span>):</span><br><span class="line">            blast_arr=[index1,index2,<span class="number">0xe9</span>,index3]</span><br><span class="line">            <span class="keyword">if</span> hashlib.sha1(<span class="built_in">bytes</span>(blast_arr)).hexdigest().lower() == compare_data:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;%02x&quot;</span>%index1,<span class="string">&quot;%02x&quot;</span>%index2,<span class="string">&#x27;e9&#x27;</span>,<span class="string">&quot;%02x&quot;</span>%index3)</span><br></pre></td></tr></table></figure>

<p>一直有疑惑为什么四组数据却只用了三组加密，然后分析第二个加密函数便明白了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">key = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0x807060504030201</span>LL;</span><br><span class="line">  v6 = <span class="number">0xC0B0A09</span>;</span><br><span class="line">  v7 = <span class="number">0xE0D</span>;</span><br><span class="line">  v8 = <span class="number">0xF</span>;</span><br><span class="line">  (generate_key)(generated_key, &amp;key);</span><br><span class="line">  len = <span class="number">16LL</span>;</span><br><span class="line">  generated_data = <span class="number">0LL</span>;</span><br><span class="line">  text_init(generated_key, a1, <span class="number">8LL</span>, &amp;generated_data, &amp;len);</span><br><span class="line">  SM4_Cipher(generated_key, &amp;generated_data, &amp;len);</span><br><span class="line">  (nullsub_2)(&amp;generated_data, <span class="number">16LL</span>);</span><br><span class="line">  <span class="keyword">return</span> generated_data == <span class="number">0xD4</span></span><br><span class="line">      &amp;&amp; *(&amp;generated_data + <span class="number">1</span>) == <span class="number">0x76D9</span></span><br><span class="line">      &amp;&amp; *(&amp;generated_data + <span class="number">3</span>) == <span class="number">0x9EFD8CED</span></span><br><span class="line">      &amp;&amp; *(&amp;generated_data + <span class="number">7</span>) == <span class="number">0xE63A562039CF7536</span>LL</span><br><span class="line">      &amp;&amp; HIBYTE(generated_data) == <span class="number">0xBF</span>;</span><br></pre></td></tr></table></figure>

<p><code>sub_44E0(&amp;v11)</code>传入八字节数据，在密钥初始化的函数中找到了SM4加密中，轮密钥生成步骤中的系统参数和字节替换步骤中的Sbox，判断其为SM4加密，并且可以在text_init函数中发现，给<code>*(a1+160)</code>设置成了0-f并且现行与输入异或。可以得知此为CBC模式的SM4加密，初始向量iv为0-f。明确于此，我们使用在线工具求解此SM4加密：（网站需要将数据转成base64）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">key = []</span><br><span class="line">iv = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    key.append(i)</span><br><span class="line">    iv.append(i)</span><br><span class="line">cmp = [<span class="number">0xD4</span>, <span class="number">0xD9</span>, <span class="number">0x76</span>, <span class="number">0xED</span>, <span class="number">0x8C</span>, <span class="number">0xFD</span>, <span class="number">0x9E</span>, <span class="number">0x36</span>, <span class="number">0x75</span>, <span class="number">0xCF</span>, <span class="number">0x39</span>, <span class="number">0x20</span>, <span class="number">0x56</span>, <span class="number">0x3A</span>, <span class="number">0xE6</span>, <span class="number">0xBF</span>]</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(<span class="built_in">bytes</span>(key)))</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(<span class="built_in">bytes</span>(iv)))</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(<span class="built_in">bytes</span>(cmp)))</span><br><span class="line"><span class="comment"># http://lzltool.com/SM4在线解密得到, 0xD1E575822D0B54FF</span></span><br><span class="line"><span class="comment"># D1E57582     2D0B54FF</span></span><br></pre></td></tr></table></figure>

<p>接下来我们看最后一个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> __fastcall <span class="title function_">sub_4630</span><span class="params">(<span class="type">unsigned</span> __int8 *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-FCh] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">112</span>]; <span class="comment">// [rsp+10h] [rbp-F8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v4[<span class="number">24</span>]; <span class="comment">// [rsp+80h] [rbp-88h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+E0h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v2 = <span class="number">100</span>;</span><br><span class="line">  sub_8960(v4);</span><br><span class="line">  sub_8980(v4, a1, <span class="number">4</span>, v3, &amp;v2);</span><br><span class="line">  sub_8DB0(v4, v3, &amp;v2);</span><br><span class="line">  <span class="keyword">return</span> v3[<span class="number">0</span>] == <span class="string">&#x27;c&#x27;</span></span><br><span class="line">      &amp;&amp; v3[<span class="number">1</span>] == <span class="string">&#x27;p&#x27;</span></span><br><span class="line">      &amp;&amp; v3[<span class="number">2</span>] == <span class="string">&#x27;V&#x27;</span></span><br><span class="line">      &amp;&amp; v3[<span class="number">3</span>] == <span class="string">&#x27;V&#x27;</span></span><br><span class="line">      &amp;&amp; v3[<span class="number">4</span>] == <span class="string">&#x27;n&#x27;</span></span><br><span class="line">      &amp;&amp; v3[<span class="number">5</span>] == <span class="string">&#x27;W&#x27;</span></span><br><span class="line">      &amp;&amp; v3[<span class="number">6</span>] == <span class="string">&#x27;=&#x27;</span></span><br><span class="line">      &amp;&amp; v3[<span class="number">7</span>] == <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从比较数据我们就基本可以大致猜测出是一个base64有关的加密,我们进入函数捕捉特征：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v18 = *(v17 - <span class="number">1</span>) &lt;&lt; <span class="number">16</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v14 &lt;= <span class="number">2</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          v19 = *v17 &lt;&lt; <span class="number">8</span>;</span><br><span class="line">          v20 = v17[<span class="number">1</span>];</span><br><span class="line">          a4[v13] = aAbcdefghijklmn[*(v17 - <span class="number">1</span>) &gt;&gt; <span class="number">2</span>];</span><br><span class="line">          a4[v13 + <span class="number">1</span>] = aAbcdefghijklmn[((v19 | v18) &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3F</span>];</span><br><span class="line">          a4[v13 + <span class="number">2</span>] = aAbcdefghijklmn[((v20 | v19) &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>];</span><br><span class="line">          a4[v13 + <span class="number">3</span>] = aAbcdefghijklmn[v20 &amp; <span class="number">0x3F</span>];</span><br><span class="line">          v13 += <span class="number">4LL</span>;</span><br><span class="line">          v17 += <span class="number">3</span>;</span><br><span class="line">          v21 = (v14 - <span class="number">3</span> &lt; <span class="number">0</span>) ^ __OFADD__(<span class="number">-3</span>, v14) | (v14 == <span class="number">3</span>);</span><br><span class="line">          v14 -= <span class="number">3</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v21 )</span><br><span class="line">          &#123;</span><br><span class="line">            v15 = &amp;a4[v13];</span><br><span class="line">            v10 = v16;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>

<p><code>abcdefghijklmnpoqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/</code>并且提取出table。到此为止，我们明确此为一个很经典的base64变表加密。我们提取出数据，直接写出解题脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">str1 = <span class="string">&quot;cpVVnW==&quot;</span></span><br><span class="line"></span><br><span class="line">string1 = <span class="string">&quot;abcdefghijklmnpoqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/&quot;</span></span><br><span class="line">string2 = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span></span><br><span class="line">arr=[]</span><br><span class="line"><span class="built_in">str</span>=base64.b64decode(str1.translate(<span class="built_in">str</span>.maketrans(string1,string2)))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">    arr.append(<span class="built_in">hex</span>(i))</span><br><span class="line"><span class="built_in">print</span>(arr)</span><br></pre></td></tr></table></figure>

<p>最后得到的三组数据，根据题目里的异或条件异或回去，并且转换成小段字节序即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">one = <span class="number">0x09e948b0</span></span><br><span class="line">two_0 = <span class="number">0x8275e5d1</span></span><br><span class="line">two_1 = <span class="number">0xff540b2d</span></span><br><span class="line">three = <span class="number">0x37efeb08</span></span><br><span class="line">flag0 = <span class="built_in">hex</span>(one ^ <span class="number">0x39DEB332</span>)[<span class="number">2</span>:]</span><br><span class="line"><span class="built_in">print</span>(flag0)</span><br><span class="line"></span><br><span class="line">flag1 = <span class="built_in">hex</span>(two_0 ^ one)[<span class="number">2</span>:]</span><br><span class="line"><span class="built_in">print</span>(flag1)</span><br><span class="line"></span><br><span class="line">flag2 = <span class="built_in">hex</span>(two_1 ^ two_0)[<span class="number">2</span>:]</span><br><span class="line"><span class="built_in">print</span>(flag2)</span><br><span class="line"></span><br><span class="line">flag3 = <span class="built_in">hex</span>(two_1 ^ three)[<span class="number">2</span>:]</span><br><span class="line"><span class="built_in">print</span>(flag3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 82fb373061ad9c8bfcee217d25e0bbc8</span></span><br></pre></td></tr></table></figure>

<p><code>flag&#123;82fb373061ad9c8bfcee217d25e0bbc8&#125;</code></p>
<h2 id="Crakeme-4"><a href="#Crakeme-4" class="headerlink" title="Crakeme 4"></a>Crakeme 4</h2><p>同Crakeme3为一道apk逆向题。MainActivity中的结构与上上题类似。对输入格式和长度的检测，并将除格式字符串外的字符串传入check函数。直接搜索java开头的native函数，并无结果。由上题积攒的经验，猜测此函数在<em>JNI_Onload</em>中动态加载。我们IDA打开so文件，反编译<em>JNI_Onload</em>函数，我们可以看到动态加载check函数的部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v6 == <span class="number">188431884</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v15 = main_main;</span><br><span class="line">                v14 = *(_OWORD *)&amp;off_38D40;</span><br><span class="line">                <span class="keyword">if</span> ( (*(<span class="type">int</span> (__fastcall **)(__int64, __int64, __int128 *, __int64))(*(_QWORD *)v13 + <span class="number">1720LL</span>))(</span><br><span class="line">                       v13,</span><br><span class="line">                       v12,</span><br><span class="line">                       &amp;v14,</span><br><span class="line">                       <span class="number">1LL</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">                  v6 = <span class="number">1424746346</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                  v6 = <span class="number">206631466</span>;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">              &#125;</span><br><span class="line">              v5 = <span class="number">-1</span>;</span><br><span class="line">              v6 = <span class="number">-944928091</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>我们可以发现这个<code>v13+1720</code>应该是一个函数，前面还涉及到*__fastcall<em>这种调用约定。我们尝试修复该函数，将数据类型改为<strong>JNIEnv</strong></em>：</p>
<p><code>if ( (*v13)-&gt;RegisterNatives(v13, (jclass)v12, (const JNINativeMethod *)&amp;v14, 1LL) &gt;= 0 )</code></p>
<p>发现可以看到用于动态注册的<em>RegisterNatives</em>的JNI函数，即代表我们修复成功。接下来我们分析主函数，其中也有一些未修复的JNI函数，我们同样的对他们进行修复：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main_main</span><span class="params">(JNIEnv *a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// w24</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// w3</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// w4</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// w5</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// w6</span></span><br><span class="line">  <span class="type">void</span> *v12; <span class="comment">// x7</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *v13; <span class="comment">// x22</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// w8</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// w15</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// w16</span></span><br><span class="line">  __int64 v17; <span class="comment">// x0</span></span><br><span class="line">  __int64 v18; <span class="comment">// x19</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// w8</span></span><br><span class="line">  jclass v21; <span class="comment">// x0</span></span><br><span class="line">  jmethodID v22; <span class="comment">// x0</span></span><br><span class="line">  jclass v23; <span class="comment">// [xsp+8h] [xbp-1108h]</span></span><br><span class="line">  __int64 blowfish_key; <span class="comment">// [xsp+10h] [xbp-1100h] BYREF</span></span><br><span class="line">  __int64 v25[<span class="number">2</span>]; <span class="comment">// [xsp+18h] [xbp-10F8h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [xsp+28h] [xbp-10E8h]</span></span><br><span class="line">  __int128 v27; <span class="comment">// [xsp+30h] [xbp-10E0h] BYREF</span></span><br><span class="line">  __int64 (__fastcall *v28)(__int64, __int64, __int64); <span class="comment">// [xsp+40h] [xbp-10D0h]</span></span><br><span class="line">  <span class="type">int</span> generat_key[<span class="number">1042</span>]; <span class="comment">// [xsp+48h] [xbp-10C8h] BYREF</span></span><br><span class="line">  <span class="type">char</span> generat_text[<span class="number">8</span>]; <span class="comment">// [xsp+1090h] [xbp-80h] BYREF</span></span><br><span class="line">  <span class="type">int</span> to_be_encrypted_text[<span class="number">4</span>]; <span class="comment">// [xsp+1098h] [xbp-78h] BYREF</span></span><br><span class="line">  __int64 v32; <span class="comment">// [xsp+10A8h] [xbp-68h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">1945572552</span>;</span><br><span class="line">  v32 = *(_QWORD *)(_ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>)) + <span class="number">40</span>);</span><br><span class="line">  v25[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  ptr = <span class="number">0LL</span>;</span><br><span class="line">  v25[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v7 = <span class="built_in">strlen</span>(a5);</span><br><span class="line">  sub_14FE0((<span class="type">char</span> *)v25, a5, v7, v8, v9, v10, v11, v12);</span><br><span class="line">  v13 = (<span class="type">unsigned</span> __int8 *)(*a1)-&gt;GetStringUTFChars(a1, a3, <span class="number">0LL</span>);</span><br><span class="line">  sub_13FC8(v13, to_be_encrypted_text);</span><br><span class="line">  blowfish_key = <span class="number">0xFFDEBC9A78563412</span>LL;</span><br><span class="line">  init_and_cipher((__int64)&amp;blowfish_key, (__int64)generat_key, <span class="number">8uLL</span>);</span><br><span class="line">  BlowFish_Cipher((<span class="type">unsigned</span> <span class="type">int</span> *)to_be_encrypted_text, generat_text, generat_key);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)generat_text[<span class="number">0</span>] != <span class="number">0x92</span></span><br><span class="line">    || (<span class="type">unsigned</span> __int8)generat_text[<span class="number">1</span>] != <span class="number">0xB1</span></span><br><span class="line">    || (<span class="type">unsigned</span> __int8)generat_text[<span class="number">2</span>] != <span class="number">0xC0</span></span><br><span class="line">    || (<span class="type">unsigned</span> __int8)generat_text[<span class="number">3</span>] != <span class="number">0x8D</span></span><br><span class="line">    || generat_text[<span class="number">4</span>] != <span class="number">0x7D</span></span><br><span class="line">    || generat_text[<span class="number">5</span>] != <span class="number">0x4D</span></span><br><span class="line">    || generat_text[<span class="number">6</span>] != <span class="number">2</span></span><br><span class="line">    || (<span class="type">unsigned</span> __int8)generat_text[<span class="number">7</span>] != <span class="number">0xB6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    (*a1)-&gt;ReleaseStringUTFChars(a1, (jstring)a3, (<span class="type">const</span> <span class="type">char</span> *)v13);</span><br><span class="line">    <span class="keyword">if</span> ( (v25[<span class="number">0</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      v15 = <span class="number">0x1EE16766</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v15 = <span class="number">0xD5748B91</span>;</span><br><span class="line">    v16 = <span class="number">0x9D4E379</span>;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( v16 &lt;= <span class="number">0x9D4E378</span> )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_15:</span><br><span class="line">        <span class="keyword">if</span> ( v16 == <span class="number">0xD2D01EF3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v17 = ((__int64 (__fastcall *)(JNIEnv *))(*a1)-&gt;NewStringUTF)(a1);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v16 == <span class="number">0xD5748B91</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v16 == <span class="number">164946809</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v16 = v15;</span><br><span class="line">        <span class="keyword">if</span> ( v15 &lt;= <span class="number">0x9D4E378</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v16 == <span class="number">0x1EE16766</span> )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_17:</span><br><span class="line">        v16 = <span class="number">0xD2D01EF3</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  (*a1)-&gt;ReleaseStringUTFChars(a1, (jstring)a3, (<span class="type">const</span> <span class="type">char</span> *)v13);</span><br><span class="line">  v27 = *(_OWORD *)&amp;off_38D28;</span><br><span class="line">  v28 = DES;</span><br><span class="line">  v23 = (*a1)-&gt;FindClass(a1, byte_3C020);</span><br><span class="line">  v14 = <span class="number">-1439435635</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v14 == <span class="number">-1439435635</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v23 )</span><br><span class="line">      v14 = <span class="number">-781376839</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v14 = <span class="number">-359426064</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v14 != <span class="number">-781376839</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">  <span class="keyword">if</span> ( (*a1)-&gt;RegisterNatives(a1, v23, (<span class="type">const</span> JNINativeMethod *)&amp;v27, <span class="number">1LL</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    v20 = <span class="number">670644798</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v20 = <span class="number">82564779</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v20 == <span class="number">82564779</span> || v20 == <span class="number">670644798</span> )</span><br><span class="line">LABEL_32:</span><br><span class="line">    v20 = <span class="number">715000375</span>;</span><br><span class="line">  v21 = (*a1)-&gt;GetObjectClass(a1, a2);</span><br><span class="line">  v22 = (*a1)-&gt;GetMethodID(a1, v21, aNehnf, &amp;unk_3C0C0);</span><br><span class="line">  v17 = sub_14BBC(a1, a2, (__int64)v22, a3);</span><br><span class="line">LABEL_24:</span><br><span class="line">  v18 = v17;</span><br><span class="line">  <span class="keyword">while</span> ( v6 != <span class="number">847613141</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (v25[<span class="number">0</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      v6 = <span class="number">847613141</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v6 = <span class="number">-519487832</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v6 == <span class="number">-519487832</span> )</span><br><span class="line">      <span class="keyword">return</span> v18;</span><br><span class="line">  &#125;</span><br><span class="line">  operator <span class="title function_">delete</span><span class="params">(ptr)</span>;</span><br><span class="line">  <span class="keyword">return</span> v18;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总体分析下来，可以发现程序其实走了两个加密函数，而第一个加密函数我们使用<code>Findcrypt</code>插件可以很轻易的识别出<em>blowfish</em>加密的常量，确定为<em>blowfish</em>加密。</p>
<p>接下来程序还将进入一个关键函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">v5 = <span class="number">1945572552</span>;</span><br><span class="line"> plaintext[<span class="number">1</span>] = *(_QWORD *)(_ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>)) + <span class="number">40</span>);</span><br><span class="line"> v21[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line"> ptr = <span class="number">0LL</span>;</span><br><span class="line"> v21[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line"> v6 = <span class="built_in">strlen</span>(a5);</span><br><span class="line"> sub_14FE0((<span class="type">char</span> *)v21, a5, v6, v7, v8, v9, v10, v11);</span><br><span class="line"> v12 = (<span class="type">unsigned</span> __int8 *)(*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(*(_QWORD *)a1 + <span class="number">1352LL</span>))(a1, a3, <span class="number">0LL</span>);</span><br><span class="line"> sub_13FC8(v12, v25);</span><br><span class="line"> key = <span class="number">0xE7CDAB8967452301</span>LL;</span><br><span class="line"> key_generation((__int64)&amp;key, (__int64)generated_key, <span class="number">0</span>, v13, v14, v15, v16);</span><br><span class="line"> DES_cipher((__int64)plaintext, ciphertext, (__int64)generated_key);</span><br><span class="line"> <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)ciphertext[<span class="number">0</span>] == <span class="number">0xE4</span></span><br><span class="line">   &amp;&amp; (<span class="type">unsigned</span> __int8)ciphertext[<span class="number">1</span>] == <span class="number">0xEA</span></span><br><span class="line">   &amp;&amp; (<span class="type">unsigned</span> __int8)ciphertext[<span class="number">2</span>] == <span class="number">0xC4</span></span><br><span class="line">   &amp;&amp; (<span class="type">unsigned</span> __int8)ciphertext[<span class="number">3</span>] == <span class="number">0x81</span></span><br><span class="line">   &amp;&amp; (<span class="type">unsigned</span> __int8)ciphertext[<span class="number">4</span>] == <span class="number">0xB9</span></span><br><span class="line">   &amp;&amp; (<span class="type">unsigned</span> __int8)ciphertext[<span class="number">5</span>] == <span class="number">0xFE</span></span><br><span class="line">   &amp;&amp; ciphertext[<span class="number">6</span>] == <span class="number">0x26</span></span><br><span class="line">   &amp;&amp; (<span class="type">unsigned</span> __int8)ciphertext[<span class="number">7</span>] == <span class="number">0xBC</span> )</span><br></pre></td></tr></table></figure>

<p>其中在<em>key_generation</em>函数中捕捉到了DES加密的常量：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">v23 = <span class="number">0LL</span>;</span><br><span class="line"> v24 = result;</span><br><span class="line"> v9 = v42;</span><br><span class="line"> v44 = *(_QWORD *)(_ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>)) + <span class="number">40</span>);</span><br><span class="line"> v43[<span class="number">2</span>] = Circular_displacement_table3;</span><br><span class="line"> v43[<span class="number">3</span>] = Circular_displacement_table4;</span><br><span class="line"> v43[<span class="number">0</span>] = Circular_displacement_table1;</span><br><span class="line"> v43[<span class="number">1</span>] = Circular_displacement_table2;</span><br><span class="line"> v10 = PC_1_8;</span><br><span class="line"> v42[<span class="number">0</span>] = PC_1_1;</span><br><span class="line"> v42[<span class="number">1</span>] = PC_1_2;</span><br><span class="line"> v42[<span class="number">6</span>] = PC_1_7;</span><br><span class="line"> v42[<span class="number">4</span>] = PC_1_5;</span><br><span class="line"> v42[<span class="number">5</span>] = PC_1_6;</span><br><span class="line"> v42[<span class="number">2</span>] = PC_1_3;</span><br><span class="line"> v42[<span class="number">3</span>] = PC_1_4;</span><br><span class="line"> v41[<span class="number">0</span>] = PC_1_8[<span class="number">0</span>];</span><br><span class="line"> v41[<span class="number">1</span>] = PC_1_8[<span class="number">1</span>];</span><br><span class="line"> v41[<span class="number">6</span>] = PC_1_14;</span><br><span class="line"> v41[<span class="number">4</span>] = PC_1_12;</span><br><span class="line"> v41[<span class="number">5</span>] = PC_1_13;</span><br><span class="line"> v11 = PC_2;</span><br><span class="line"> v41[<span class="number">2</span>] = PC_1_8[<span class="number">2</span>];</span><br><span class="line"> v41[<span class="number">3</span>] = PC_1_8[<span class="number">3</span>];</span><br><span class="line"> v40[<span class="number">2</span>] = PC_2[<span class="number">2</span>];</span><br><span class="line"> v40[<span class="number">3</span>] = PC_2[<span class="number">3</span>];</span><br><span class="line"> v40[<span class="number">0</span>] = PC_2[<span class="number">0</span>];</span><br><span class="line"> v40[<span class="number">1</span>] = PC_2[<span class="number">1</span>];</span><br><span class="line"> v40[<span class="number">6</span>] = PC_2[<span class="number">6</span>];</span><br><span class="line"> v40[<span class="number">7</span>] = PC_2[<span class="number">7</span>];</span><br><span class="line"> v40[<span class="number">4</span>] = PC_2[<span class="number">4</span>];</span><br><span class="line"> v40[<span class="number">5</span>] = PC_2[<span class="number">5</span>];</span><br><span class="line"> v40[<span class="number">10</span>] = PC_2[<span class="number">10</span>];</span><br><span class="line"> v40[<span class="number">11</span>] = PC_2[<span class="number">11</span>];</span><br><span class="line"> v40[<span class="number">8</span>] = PC_2[<span class="number">8</span>];</span><br><span class="line"> v40[<span class="number">9</span>] = PC_2[<span class="number">9</span>]</span><br></pre></td></tr></table></figure>

<p>如循环位移表，PC置换盒，同样的，我们进入<em>DES_cipher</em>，可以分析确认出DES加密的轮函数，轮加密所使用的S盒等等。确认此为一个标准的DES加密。且上述两个加密都未发现初始向量，等其他加密模式的特征，为最原始的ECB加密模式，据此，我们写出解题代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> Blowfish</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"></span><br><span class="line">Blowfish_key=<span class="built_in">bytes</span>([<span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0x78</span>, <span class="number">0x9A</span>, <span class="number">0xBC</span>, <span class="number">0xDE</span>, <span class="number">0xFF</span>])</span><br><span class="line">Blowfish_ciphertext=<span class="built_in">bytes</span>([<span class="number">0x92</span>, <span class="number">0xB1</span>, <span class="number">0xC0</span>, <span class="number">0x8D</span>, <span class="number">0x7D</span>, <span class="number">0x4D</span>, <span class="number">0x02</span>, <span class="number">0xB6</span>])</span><br><span class="line">Blowfish_cipher=Blowfish.new(Blowfish_key,Blowfish.MODE_ECB)</span><br><span class="line">flag1=Blowfish_cipher.decrypt(Blowfish_ciphertext)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;flag&#123;&#x27;</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> flag1:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&#123;:02x&#125;&quot;</span>.<span class="built_in">format</span>(i),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">DES_key=<span class="built_in">bytes</span>([<span class="number">0x01</span>, <span class="number">0x23</span>, <span class="number">0x45</span>, <span class="number">0x67</span>, <span class="number">0x89</span>, <span class="number">0xab</span>, <span class="number">0xcd</span>, <span class="number">0xe7</span>])</span><br><span class="line">DES_ciphertext=<span class="built_in">bytes</span>([<span class="number">0xE4</span>, <span class="number">0XEA</span>, <span class="number">0XC4</span>, <span class="number">0X81</span>, <span class="number">0xB9</span>, <span class="number">0xFE</span>, <span class="number">0x26</span>, <span class="number">0xBC</span>])</span><br><span class="line">DES_cipher=DES.new(DES_key,DES.MODE_ECB)</span><br><span class="line">flag2=DES_cipher.decrypt(DES_ciphertext)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> flag2:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&#123;:02x&#125;&quot;</span>.<span class="built_in">format</span>(i),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#125;&#x27;</span>,end=<span class="string">&#x27;&#x27;</span>)  </span><br></pre></td></tr></table></figure>

<p><code>flag&#123;3d1cda6eccd30edae3696515def8d5b9&#125;</code></p>
<p>小小总结一下这两道apk逆向，自己基础不够扎实，其实还是跟着wp去复现，才知道apk逆向的基本步骤，学到最重要的一点就是，调用c组件里的函数除了通过导出函数直接调用native函数（直接搜索java开头的native函数即可查找），还可以在运行的过程中动态注册。遇到这种情况，就分析JNI_Onload函数，里面大概率会调用<em>RegisterNatives</em>这种JNI函数去动态注册所需函数。IDA对这些JNI函数的识别并不是很理想，很多时候需要我们手动修改数据类型为<strong>JNIEnv</strong>*来帮助IDA识别函数以辅助我们进一步分析程序。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://kamasammohana.github.io/2022/07/05/%E5%9B%BD%E8%B5%9B%E5%88%86%E5%8C%BA%E8%B5%9BReverse/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2022/08/06/%E9%B9%8F%E5%9F%8E%E6%9D%AFReverse/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            (no title)
          
        </div>
      </a>
    
    
      <a href="/2022/07/01/normal/normal/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title"></div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022
        <i class="ri-heart-fill heart_icon"></i> Syclover.Kama
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Kama"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="http://bcyng-w.github.io">友链B</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="http://sycskye.xyz">友链C</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="http://lzhnb.site">友链H</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=1824020871&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
</body>

</html>